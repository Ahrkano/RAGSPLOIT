# -*- coding: utf-8 -*-
import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from metasploit_client import MetasploitClient

def format_post_card(name, description, session_type):
    return f"""
=== METASPLOIT POST-EXPLOITATION CARD ===
NAME: post/{name}
TYPE: post
SESSION_REQ: {session_type}
KEYWORDS: {name.replace('/', ' ')} loot gather enum persistence
DESCRIPTION: {description.strip()}
USAGE_NOTE: Run this AFTER getting a session. Use 'use post/{name}', set SESSION <id>, then exploit.
=========================================
"""

def main():
    print("[DB_05] === GERADOR DE POS-EXPLORACAO ===")
    
    # Lista curada de modulos vitais de pos-exploracao
    post_modules = [
        # Linux
        {"name": "linux/gather/hashdump", "desc": "Dumps the /etc/shadow password hashes.", "sess": "shell/meterpreter"},
        {"name": "linux/gather/enum_network", "desc": "Enumerates network interfaces and routes.", "sess": "shell/meterpreter"},
        {"name": "linux/gather/enum_system", "desc": "Enumerates OS info, kernel, hostname.", "sess": "shell/meterpreter"},
        {"name": "linux/gather/checkvm", "desc": "Checks if the target is a Virtual Machine.", "sess": "shell/meterpreter"},
        # Multi
        {"name": "multi/manage/shell_to_meterpreter", "desc": "Upgrades a basic shell to Meterpreter.", "sess": "shell"},
        {"name": "multi/recon/local_exploit_suggester", "desc": "Suggests local exploits for privilege escalation.", "sess": "meterpreter"}
    ]
    
    cards = []
    for m in post_modules:
        cards.append(format_post_card(m['name'], m['desc'], m['sess']))

    output_path = "/app/config/ingest/kb_post_exploit.txt"
    with open(output_path, "w", encoding="utf-8") as f:
        f.write("\n".join(cards))
    print(f"[DB_05] [SUCESSO] Gerados {len(cards)} Cards de Pos-Exploracao.")

if __name__ == "__main__":
    main()